<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Template GitLab</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .form-check-label {
        cursor: pointer;
    }
    .list-group-item:hover {
        background-color: #e9ecef;
        box-shadow: inset 0 0 5px #ccc;
    }
    #listaPassos .list-group-item:hover {
        background-color: #e0f7fa; /* azul claro */
    }

    #listaCriterios .list-group-item:hover {
        background-color: #fff3cd; /* amarelinho claro */
    }

    hr.section-divider {
        border-top: 3px solid #000000;
        margin: 2rem 0;
        box-shadow: inset 0 1px 0 rgb(23, 27, 41);
    }

    .generate-shortcut:hover small {
        color: #f8f9fa !important;
    }

    .toolbar-custom {
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
    }

    .toolbar-custom .btn {
        min-width: 200px;
        text-align: left;
    }

    button.btn-outline-secondary {
        border: aliceblue !important;
    }
    .input-group {
        position: relative;
    }
    .sug-autocomplete {
        position: absolute;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        z-index: 1050; /* aumentar para ficar acima dos inputs */
        display: none;
        width: 100%; /* ocupa toda a largura do input */
        max-height: 200px;
        overflow-y: auto;
        top: 100%; /* força a ficar abaixo do input */
        left: 0;
    }

.sug-autocomplete .list-group-item {
  font-weight: 500;
  padding: 10px 15px;
  cursor: pointer;
  border: none;
  white-space: nowrap;
  width: 100%;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  background-color: #f8f9fa;
  transition: background-color 0.15s ease-in-out;
}

.sug-autocomplete .list-group-item:hover {
  background-color: #193764 !important;
  color: white !important;
  font-weight: bold;
}

.modal-body ul.list-group {
  border: 1px solid #dee2e6;
  border-radius: 0.5rem;
  background-color: #f9f9f9;
}


    </style>
</head>

<body class="bg-dark text-light">
  <div class="container py-3 mb-0">
    <div class="card mx-auto shadow" style="max-width: 800px; border-radius: 12px;">
      <div class="card-body bg-white text-dark p-4 rounded">
          <div class="container py-3">
    <h2 id="tituloPrincipal" class="mb-4"><i class="fas fa-tools"></i> Gerador de Template GitLab</h2>

    <div class="d-flex justify-content-between align-items-center gap-3">
        <button class="btn btn-outline-secondary btn-sm me-2 my-2" data-bs-toggle="modal" data-bs-target="#modalImportar">
            <i class="fas fa-upload"></i> Importar template
        </button>

        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAjuda">
            <i class="fas fa-info-circle"></i>
        </button>
    </div>

    <div class="modal fade" id="modalAjuda" tabindex="-1" aria-labelledby="modalAjudaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content text-dark">
        <div class="modal-header">
            <h5 class="modal-title" id="modalAjudaLabel"><i class="fas fa-info-circle me-2"></i>Ajuda e Recursos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
            <ul class="list-group list-group-flush">
            <li class="list-group-item">
                <i class="fas fa-shoe-prints text-primary me-2"></i>
                <strong>Passos:</strong> Pressione <kbd>Enter</kbd> para adicionar. Digite <code>&gt;</code> para gerar <span class="text-success">→</span>. 
                Ao digitar <code>(</code>, aparecem atalhos como <code>Categoria (PL020)</code>, que viram <strong>negrito</strong> no markdown.
            </li>
            <li class="list-group-item">
                <i class="fas fa-bolt text-warning me-2"></i>
                <strong>Atalhos:</strong> Digite <code>/</code> em um campo de passo para abrir <em>blocos inteligentes</em> com múltiplos passos.
            </li>
            <li class="list-group-item">
                <i class="fas fa-layer-group text-info me-2"></i>
                <strong>Preparativos:</strong> Grupos extras de passos com título. Também aceitam blocos e atalhos com <code>(</code>.
            </li>
            <li class="list-group-item">
                <i class="fas fa-code text-danger me-2"></i>
                <strong>Markdown:</strong> Estrutura otimizada para reuso. Use <kbd>Alt</kbd> + <kbd>Enter</kbd> para gerar instantaneamente.
            </li>
            <li class="list-group-item">
                <i class="fas fa-file-export text-success me-2"></i>
                <strong>Importar/Exportar:</strong> Salve ou compartilhe com arquivos <code>.json</code>.
            </li>
            <li class="list-group-item">
                <i class="fas fa-folder-open text-secondary me-2"></i>
                <strong>Personalização:</strong> Você pode adicionar novos <code>shortcuts</code> e <code>blocos de passos</code> diretamente no arquivo <code>shortcuts.js</code>, dentro da pasta do projeto.
            </li>
            </ul>
        </div>
        </div>
    </div>
    </div>

    <div class="modal fade" id="modalImportar" tabindex="-1" aria-labelledby="modalImportarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content text-dark">
        <div class="modal-header">
            <h5 class="modal-title" id="modalImportarLabel">
            <i class="fas fa-file-import me-2"></i>Importar Template GitLab
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
            <label for="arquivoJson" class="form-label">Selecionar arquivo .json</label>
            <input type="file" id="arquivoJson" accept=".json" class="form-control">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-success" onclick="importarArquivoJson()">Importar agora</button>
        </div>
        </div>
    </div>
    </div>

    <div class="mb-3">
    <label class="form-label">
        <i class="fas fa-tag"></i>Tarefa:
    </label>
        <input type="text" class="form-control" id="nomeTarefa" placeholder="Ex: ACT-1111">
    </div>

    <div class="mb-3">
        <label class="form-label">
            <i class="fas fa-circle"></i>
        Escopo:
        </label>
      <input type="text" class="form-control" id="escopo" placeholder="Descrever o que foi feito">
    </div>

    <hr class="section-divider">

    <div class="mb-1 d-flex align-items-center">
        <i class="fas fa-toolbox me-2 text-secondary"></i>
        <h5 class="mb-0 fw-bold">Preparativos</h5>
    </div>

    <div class="mb-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="adicionarPreparativo()">
        <i class="fas fa-plus"></i> Adicionar Preparativo
    </button>
    </div>

    <div id="containerPreparativos"></div>

    <hr class="section-divider">

    <div class="mb-2">
        <label class="form-label" for="novoPasso">
            <i class="fas fa-shoe-prints"></i> Passo de teste:
        </label>
        <div class="input-group">
            <input type="text" id="novoPasso" class="form-control" placeholder="Digite um passo e pressione Enter">
            <button class="btn btn-outline-success" type="button" onclick="adicionarPasso()">
                <i class="fas fa-plus"></i>
            </button>
            <div id="sugestoesPasso" class="list-group position-absolute z-3 sug-autocomplete" style="display: none;"></div>
        </div>
    </div>

    <div class="modal fade" id="modalBlocos" tabindex="-1" aria-labelledby="modalBlocosLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content text-dark">
        <div class="modal-header">
            <h5 class="modal-title" id="modalBlocosLabel">Inserir passos pré-definidos</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
            <div id="modalBlocosBody" class="list-group"></div>
        </div>
        </div>
    </div>
    </div>

    <ul class="list-group mb-4" id="listaPassos"></ul>

    <hr class="section-divider">

    <div class="mb-3">
        <label class="form-label"><i class="fas fa-exclamation-triangle"></i> Critérios de Aceitação:</label>
            <div class="input-group mb-2">
                <input type="text" id="novoCriterio" class="form-control" placeholder="Descreva o critério e pressione Enter">
                <button class="btn btn-outline-secondary" type="button" onclick="adicionarCriterio()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        <ul class="list-group" id="listaCriterios"></ul>
    </div>

    <hr class="section-divider">

    <div class="mb-4">
        <label class="form-label">
            <i class="fas fa-flag"></i> Impacto:
        </label>
      <textarea class="form-control" id="impacto" rows="3" placeholder="1. Impacta tal módulo..."></textarea>
    </div>

    <hr class="section-divider">

    <div class="mb-3">
      <label class="form-label"><i class="fas fa-globe"></i> Navegadores testados:</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="chrome">
        <label class="form-check-label" for="chrome">Google Chrome</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="edge">
        <label class="form-check-label" for="edge">Microsoft Edge</label>
      </div>
    </div>

    <hr class="section-divider">

    <div class="mb-4">
      <label class="form-label"><i class="fas fa-save"></i> Bancos de dados testados:</label>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="sqlserver">
        <label class="form-check-label" for="sqlserver">SQL Server (ISO 8859-1)</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="oracleIso">
        <label class="form-check-label" for="oracleIso">Oracle (ISO 8859-1)</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="postgres">
        <label class="form-check-label" for="postgres">PostGreSQL (UTF8)</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="oracleUtf">
        <label class="form-check-label" for="oracleUtf">Oracle (UTF8)</label>
      </div>
    </div>

    <hr class="section-divider">

    <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap bg-light p-3 rounded shadow-sm toolbar-custom">
    <button class="btn btn-secondary btn-sm flex-fill" onclick="gerar()">
        <i class="fa-solid fa-gears me-1"></i> Gerar Markdown
        <small class="text-white-50 ms-1">(Alt + Enter)</small>
    </button>

    <button class="btn btn-outline-secondary btn-sm flex-fill" data-bs-toggle="modal" data-bs-target="#modalExportar">
        <i class="fas fa-download me-1"></i> Exportar template
    </button>

    <button class="btn btn-outline-danger btn-sm flex-fill" onclick="limparDraft()">
        <i class="fas fa-broom me-1"></i> Limpar rascunho
    </button>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <h5>
            <i class="fas fa-clipboard"></i>
            Resultado:
        </h5>
        <button id="copy_btn" disabled="true" class="btn btn-outline-secondary btn-sm my-2" onclick="copiarResultado()">
            <i class="fas fa-copy"></i> Copiar
        </button>
    </div>
    <textarea class="form-control" id="resultado" rows="25" readonly></textarea>
  </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="modalExportar" tabindex="-1" aria-labelledby="modalExportarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content text-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="modalExportarLabel">
          <i class="fas fa-file-export me-2"></i>Exportar Template GitLab
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <label for="nomeExportar" class="form-label">Nome do arquivo</label>
        <input type="text" id="nomeExportar" class="form-control" placeholder="ex: plano-teste-2024">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" onclick="exportarJson()">Exportar agora</button>
      </div>
    </div>
  </div>
</div>

  <div class="modal fade text-dark" id="modalCriterios" tabindex="-1" aria-labelledby="modalCriteriosLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="modalCriteriosLabel">Gerenciar passo de teste</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
             <div class="mb-3">
                <label for="editarTextoPasso" class="form-label">
                    <i class="fa-solid fa-pencil"></i> Editar passo
                </label>
                <input type="text" id="editarTextoPasso" class="form-control">
            </div>
            <label for="editarTextoPasso" class="form-label">
                <i class="fa-solid fa-link"></i> Vincular critério de aceitação
            </label>
            
            <div id="listaCriteriosModal"></div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="confirmarVinculoCriterios()">Salvar</button>
        </div>
        </div>
    </div>
    </div>

    <footer class="text-center mt-1 text-white" style="font-size: 0.9rem;">
        Desenvolvido por <strong>Lindomar Lima - ACT</strong>
    </footer>

  <script src="./shortcuts.js"></script>
  <script>

    let currentTemplateId = null;
    let nomeTarefa = '';

    function escaparUnderscores(texto) {
      return texto.replace(/_/g, '\\_');
    }

    let preparativos = [];
    let passos = [];

    function adicionarPreparativo() {
        preparativos.push({
            titulo: '',
            passos: []
        });
        renderizarPreparativos();
    }

    function adicionarPasso() {
        const input = document.getElementById('novoPasso');
        const valor = input.value.trim();
        const estavaFocado = document.activeElement === input;

        if (valor !== '') {
            passos.push({ texto: valor, critico: false, criteriosVinculados: [] });
            input.value = '';
            renderizarPassos();

            if (estavaFocado) input.focus();
        }
    }

    function removerPasso(index) {
        passos.splice(index, 1);
        renderizarPassos();
    }

    function removerPreparativo(index) {
        preparativos.splice(index, 1);
        renderizarPreparativos();
    }

    function adicionarPassoPreparativo(index) {
        const input = document.getElementById(`prepPassoInput${index}`);
        const valor = input.value.trim();

        if (valor !== '') {
            preparativos[index].passos.push(valor);
            input.value = '';
            renderizarPreparativos();
        }
    }

    function removerPassoPreparativo(prepIndex, passoIndex) {
        preparativos[prepIndex].passos.splice(passoIndex, 1);
        renderizarPreparativos();
    }

    function renderizarPreparativos() {
        const container = document.getElementById('containerPreparativos');
        container.innerHTML = '';

        preparativos.forEach((prep, i) => {
            const div = document.createElement('div');
            div.className = 'card my-3';

            div.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <input type="text" class="form-control form-control-sm me-2" placeholder="Título do preparativo"
                    value="${prep.titulo}" onchange="preparativos[${i}].titulo = this.value">
                <button class="btn btn-sm btn-outline-danger" onclick="removerPreparativo(${i})">
                <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="input-group mb-2 position-relative">
                <input type="text" class="form-control" placeholder="Novo passo" id="prepPassoInput${i}"
                    oninput="inputPreparativoHandler(event, ${i})"
                    onblur="setTimeout(esconderSugestoes, 150)"
                    onkeypress="if(event.key==='Enter'){event.preventDefault(); adicionarPassoPreparativo(${i})}">
                <button class="btn btn-outline-success" onclick="adicionarPassoPreparativo(${i})">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="list-group position-absolute z-3 sug-autocomplete" id="prepSugestoes${i}" style="display: none;"></div>
                </div>
                <ul class="list-group">
                ${prep.passos.map((p, j) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span class="editable" onclick="editarPassoPreparativo(${i}, ${j}, this)">${j + 1}. ${p}</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="removerPassoPreparativo(${i}, ${j})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </li>
                `).join('')}
                </ul>
            </div>
            `;

            setTimeout(() => {
                document.getElementById('prepPassoInput' + i)?.addEventListener('input', function (e) {
                    aplicarSubstituicoesSeta(e.target);
                });
            }, 0);

                    setTimeout(() => {
  const input = document.getElementById('prepPassoInput' + i);
  if (input) {
    input.addEventListener('input', function (e) {
      aplicarSubstituicoesSeta(e.target);
      atualizarSugestoesPorParenteses(e.target, `prepSugestoes${i}`);

      if (e.target.value.trim() === '/') {
        mostrarModalBlocos(i);
      }
    });

    input.addEventListener('blur', () =>
      setTimeout(() => esconderSugestoes(`prepSugestoes${i}`), 150)
    );
  }
}, 0);

            container.appendChild(div);
        });
    }

    function editarPassoPreparativo(prepIndex, passoIndex, spanEl) {
        const textoOriginal = preparativos[prepIndex].passos[passoIndex];
        const input = document.createElement('input');
        input.type = 'text';
        input.value = textoOriginal;
        input.className = 'form-control form-control-sm';
        input.style.flex = '1';
        input.onblur = salvarEdicao;
        input.onkeypress = function (e) {
            if (e.key === 'Enter') {
            e.preventDefault();
            salvarEdicao();
            }
        };

        function salvarEdicao() {
            const novoValor = input.value.trim();
            if (novoValor !== '') {
            preparativos[prepIndex].passos[passoIndex] = novoValor;
            renderizarPreparativos();
            }
        }

        spanEl.replaceWith(input);
        input.focus();
    }

    function renderizarPassos() {
        const lista = document.getElementById('listaPassos');
        lista.innerHTML = '';
        passos.forEach((passo, index) => {
            const badge = passo.critico ? '<span class="badge bg-warning text-dark ms-2">⚠️ crítico</span>' : '';
            const criteriosVinculados = passo.criteriosVinculados?.length
                ? `<small class="text-muted ms-2">→ Critérios: ${passo.criteriosVinculados.map(c => c + 1).join(', ')}</small>`
                : '';
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.setAttribute('onclick', `selecionarCriterios(${index})`);
            li.style.cursor = 'pointer';

            const criteriosBadge = passo.criteriosVinculados.length
            ? `<span class="badge bg-warning text-dark ms-2 fw-semibold">${formatarListaOrdinal(
                passo.criteriosVinculados.map(c => c + 1)
                )}</span>`
            : '';

            li.innerHTML = `
            <span>
                ${escaparUnderscores((index + 1) + '. ' + passo.texto)}${criteriosBadge}
            </span>
            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); removerPasso(${index})">
                <i class="fas fa-trash-alt"></i>
            </button>
            `;

            lista.appendChild(li);
        });
    }

    function formatarListaOrdinal(numeros) {
        if (numeros.length === 1) return `critério ${numeros[0]}`;
        const ultimos = numeros.slice(0, -1).join(', ');
        return `critérios ${ultimos} e ${numeros[numeros.length - 1]}`;
    }

    let criterios = [];

    function adicionarCriterio() {
        const input = document.getElementById('novoCriterio');
        const valor = input.value.trim();
        const estavaFocado = document.activeElement === input;

        if (valor !== '') {
            criterios.push(valor);
            input.value = '';
            renderizarCriterios();

            if (estavaFocado) input.focus();
        }
    }

    function removerCriterio(index) {
        criterios.splice(index, 1);
        renderizarCriterios();
    }

    function renderizarCriterios() {
    const lista = document.getElementById('listaCriterios');
    lista.innerHTML = '';
    criterios.forEach((criterio, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
        <span>${escaparUnderscores((index + 1) + '. ' + criterio)}</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="removerCriterio(${index})">
            <i class="fas fa-trash-alt"></i>
        </button>
        `;
        lista.appendChild(li);
    });
    }

    // Enter para adicionar critério
    document.getElementById('novoCriterio').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            adicionarCriterio();
        }
    });

    // Permitir Enter para adicionar passo
    document.getElementById('novoPasso').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        adicionarPasso();
    }
    });

    function gerar() {
    const escopo = escaparUnderscores(document.getElementById('escopo').value.trim());
    const criteriosTexto = criterios.map((c, i) => `${i + 1}. ${escaparUnderscores(c)}`).join('\n');
    const impactoBruto = document.getElementById('impacto').value.trim();
    const impacto = escaparUnderscores(
    impactoBruto.replace(/\(([A-Z]{2}\d{3})\)/g, '(**$1**)')
    );

  const navegadoresSelecionados = document.getElementById('chrome').checked || document.getElementById('edge').checked;
  const bancosSelecionados = document.getElementById('sqlserver').checked || document.getElementById('oracleIso').checked || document.getElementById('postgres').checked || document.getElementById('oracleUtf').checked;
  
  if (!navegadoresSelecionados || !bancosSelecionados) {
    Swal.fire({
      icon: 'warning',
      title: 'Campos obrigatórios',
      text: 'Você precisa selecionar pelo menos um navegador e um banco de dados para gerar o template.',
    });
    return;
  }

  const preparativosTexto = preparativos.map((p, i) => {
  const titulo = p.titulo ? ` (**${p.titulo}**)` : '';
  const passos = p.passos.map((passo, j) =>
    `${j + 1}. ${escaparUnderscores(passo.replace(/\(([A-Z]{2}\d{3})\)/g, '(**$1**)'))}`
    ).join('\n');
  return `### :rosette: Preparativo ${i + 1}${titulo}\n${passos}`;}).join('\n\n');

    let warningCount = 1;
const passosTexto = passos.map((p, i) => {
    const isCritico = p.criteriosVinculados?.length > 0;
    const textoLimpo = escaparUnderscores(
        p.texto.replace(/\(([A-Z]{2}\d{3})\)/g, '(**$1**)')
    );
    const sufixo = p.criteriosVinculados?.length
    ? ` :warning: (${p.criteriosVinculados.map(c => c + 1).join(',')})`
    : '';
    return `${i + 1}. ${textoLimpo}${sufixo}`;
}).join('\n');

  const chrome = document.getElementById('chrome').checked ? "* [X] Google Chrome\n" : "* [ ] Google Chrome\n";
  const edge = document.getElementById('edge').checked ? "* [X] Microsoft Edge\n" : "* [ ] Microsoft Edge\n";

  const sqlserver = document.getElementById('sqlserver').checked ? "    * [X] SQL Server\n" : "    * [ ] SQL Server\n";
  const oracleIso = document.getElementById('oracleIso').checked ? "    * [X] Oracle\n" : "    * [ ] Oracle\n";
  const postgres = document.getElementById('postgres').checked ? "    * [X] PostGreSQL\n" : "    * [ ] PostGreSQL\n";
  const oracleUtf = document.getElementById('oracleUtf').checked ? "    * [X] Oracle\n" : "    * [ ] Oracle\n";

    let markdown = `### :star: Escopo \n\n 1. *${escopo}*
    `;

    if (preparativosTexto) {
        markdown += `\n____\n${preparativosTexto}\n`;
    }

markdown += `
____
### :mans\\_shoe: Passos
${passosTexto}

____
### :warning: Critério de aceitação
${criteriosTexto}
____
### :triangular\\_flag\\_on\\_post: Impacto
${impacto}
____
### :ship: Navegadores testados:
${chrome}${edge}____
### :game\\_die: Bancos de dados testados:
* **ISO 8859-1**:
${sqlserver}${oracleIso}* **UTF8**:
${postgres}${oracleUtf}
### :eyeglasses: [Evidências](https://www.youtube.com/watch?v=ePjtnSPFWK8)
* Evidências:
   * [X]  [DEV](#evidencia_dev)
   * [ ]  [CROSS](#evidencia_cross)
   * [ ]  [QA](#evidencia_qa)`;

  document.getElementById('resultado').value = markdown;
  document.getElementById('copy_btn').disabled = false;

    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title: 'Markdown gerado com sucesso!',
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true
    });
}


  </script>

  <script>
  let passoSelecionadoIndex = null;

  function selecionarCriterios(index) {
  passoSelecionadoIndex = index;
  const container = document.getElementById('listaCriteriosModal');
  document.getElementById('editarTextoPasso').value = passos[index].texto;

  // Limpa conteúdo anterior
  container.innerHTML = '';

  if (!criterios.length) {
    container.innerHTML = '<p class="text-muted">Nenhum critério foi adicionado ainda.</p>';
  } else {
    criterios.forEach((criterio, i) => {
      const checkbox = document.createElement('div');
      checkbox.className = 'form-check';

      const isChecked = passos[index].criteriosVinculados.includes(i);

      checkbox.innerHTML = `
        <input class="form-check-input" type="checkbox" value="${i}" id="criterioCheck${i}" ${isChecked ? 'checked' : ''}>
        <label class="form-check-label" for="criterioCheck${i}">
          ${i + 1}. ${escaparUnderscores(criterio)}
        </label>
      `;

      container.appendChild(checkbox);
    });
  }

  const modal = new bootstrap.Modal(document.getElementById('modalCriterios'));
  modal.show();
}


  function confirmarVinculoCriterios() {
    const checkboxes = document.querySelectorAll('#listaCriteriosModal input[type=checkbox]');
    const selecionados = [];

    checkboxes.forEach(cb => {
      if (cb.checked) {
        selecionados.push(parseInt(cb.value));
      }
    });

    if (passoSelecionadoIndex !== null) {
      passos[passoSelecionadoIndex].criteriosVinculados = selecionados;
      renderizarPassos();
    }

    if (passoSelecionadoIndex !== null) {
        passos[passoSelecionadoIndex].texto = document.getElementById('editarTextoPasso').value.trim();
        passos[passoSelecionadoIndex].criteriosVinculados = selecionados;
        renderizarPassos();
    }

    const modalEl = document.getElementById('modalCriterios');
    const modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
  }

  function copiarResultado() {
    const texto = document.getElementById('resultado').value;
    navigator.clipboard.writeText(texto).then(() => {
        Swal.fire({
        icon: 'success',
        title: 'Copiado!',
        text: 'O markdown foi copiado para a área de transferência.',
        timer: 2000,
        showConfirmButton: false
        });
    }).catch(() => {
        Swal.fire({
        icon: 'error',
        title: 'Erro!',
        text: 'Não foi possível copiar o texto.',
        });
    });
}

window.addEventListener('beforeunload', () => {
  const id = currentTemplateId || gerarIdTemplate();
  currentTemplateId = id;

  nomeTarefa = document.getElementById('nomeTarefa').value.trim();

  const draft = {
    templateId: id,
    nomeTarefa,
    escopo: document.getElementById('escopo').value,
    impacto: document.getElementById('impacto').value,
    criterios,
    passos,
    preparativos,
    navegadores: {
      chrome: document.getElementById('chrome').checked,
      edge: document.getElementById('edge').checked
    },
    bancos: {
      sqlserver: document.getElementById('sqlserver').checked,
      oracleIso: document.getElementById('oracleIso').checked,
      postgres: document.getElementById('postgres').checked,
      oracleUtf: document.getElementById('oracleUtf').checked
    }
  };

  localStorage.setItem('template_gitlab_draft', JSON.stringify(draft));
});

window.addEventListener('DOMContentLoaded', () => {
  const keys = Object.keys(localStorage).filter(k => k.startsWith('template_gitlab_'));
  
  if (keys.length > 0) {
    const draft = localStorage.getItem('template_gitlab_draft');
    const data = JSON.parse(draft);
    currentTemplateId = data.templateId || keys[0].replace('template_gitlab_', '');

    document.getElementById('nomeTarefa').value = data.nomeTarefa || '';
    nomeTarefa = data.nomeTarefa || 'Gerador de Template GitLab';

    document.getElementById('tituloPrincipal').innerHTML = `
    <i class="fas fa-tools"></i> Gerador de Template GitLab 
    ${nomeTarefa ? `<small class="text-muted">(${nomeTarefa})</small>` : ''}
    `;

    document.title = nomeTarefa + '-template' || 'Gerador de Template GitLab';

    // Restaurar campos simples
    document.getElementById('escopo').value = data.escopo || '';
    document.getElementById('impacto').value = data.impacto || '';

    // Restaurar navegadores
    document.getElementById('chrome').checked = data.navegadores?.chrome || false;
    document.getElementById('edge').checked = data.navegadores?.edge || false;

    // Restaurar bancos
    document.getElementById('sqlserver').checked = data.bancos?.sqlserver || false;
    document.getElementById('oracleIso').checked = data.bancos?.oracleIso || false;
    document.getElementById('postgres').checked = data.bancos?.postgres || false;
    document.getElementById('oracleUtf').checked = data.bancos?.oracleUtf || false;

    // Restaurar critérios e passos
    criterios = data.criterios || [];
    passos = data.passos || [];
    preparativos = data.preparativos || [];

    renderizarCriterios();
    renderizarPassos();
    renderizarPreparativos();

    // Atualiza visual
    document.getElementById('nomeExportar').value = nomeTarefa;
  }
});

document.getElementById('nomeTarefa').addEventListener('input', (e) => {
  const valor = e.target.value.trim();
  nomeTarefa = valor;
  document.title = valor + '-template' || 'Gerador de Template GitLab';
  
  document.getElementById('tituloPrincipal').innerHTML = `
    <i class="fas fa-tools"></i> Gerador de Template GitLab 
    ${valor ? `<small class="text-muted">(${valor})</small>` : ''}
  `;
});

document.addEventListener('keydown', function (e) {
  if (e.altKey && e.key === 'Enter') {
    e.preventDefault();
    gerar();
  }
});

function limparDraft() {
  Swal.fire({
    icon: 'question',
    title: 'Apagar rascunho salvo?',
    text: 'Todos os dados armazenados localmente serão perdidos.',
    showCancelButton: true,
    confirmButtonText: 'Sim, apagar',
    cancelButtonText: 'Cancelar'
  }).then((result) => {
    if (result.isConfirmed) {
      const keyToDelete = currentTemplateId ? `template_gitlab_${currentTemplateId}` : 'gitlab_template_draft';
      localStorage.removeItem(keyToDelete);  // <-- Aqui está o pulo do gato

      // Limpa os campos de texto
      document.getElementById('nomeTarefa').value = '';
      document.getElementById('escopo').value = '';
      document.getElementById('impacto').value = '';
      document.getElementById('novoPasso').value = '';
      document.getElementById('novoCriterio').value = '';
      document.getElementById('resultado').value = '';

      // Limpa checkboxes
      document.getElementById('chrome').checked = false;
      document.getElementById('edge').checked = false;
      document.getElementById('sqlserver').checked = false;
      document.getElementById('oracleIso').checked = false;
      document.getElementById('postgres').checked = false;
      document.getElementById('oracleUtf').checked = false;

      // Limpa arrays e re-renderiza
      passos = [];
      criterios = [];
      preparativos = [];
      renderizarPassos();
      renderizarCriterios();
      renderizarPreparativos();

      // Zera id e título
      currentTemplateId = null;
      nomeTarefa = '';
      document.title = 'Gerador de Template GitLab';
      document.getElementById('tituloPrincipal').innerHTML = `
        <i class="fas fa-tools"></i> Gerador de Template GitLab
      `;

      Swal.fire({
        icon: 'success',
        title: 'Rascunho apagado!',
        text: 'Agora está tudo limpo. 🧼',
        timer: 2000,
        showConfirmButton: false
      });
    }
  });
}

function mostrarSugestoes(filtroParcial, inputRef, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    container.innerHTML = '';

    const sugestoesFiltradas = sugestoesAutoComplete.filter(s =>
        s.id.toLowerCase().startsWith(filtroParcial.toLowerCase())
    );

    if (!sugestoesFiltradas.length) {
        container.style.display = 'none';
        return;
    }

  sugestoesFiltradas.forEach(sugestao => {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'list-group-item list-group-item-action';
    item.textContent = sugestao;
    item.style.backgroundColor = '#cfe2ff';

    item.addEventListener('mousedown', (e) => {
      e.preventDefault();
      const textoAtual = inputRef.value;
      const inicioParenteses = textoAtual.lastIndexOf('(');
      inputRef.value = textoAtual.slice(0, inicioParenteses) + `${sugestao.name} (${sugestao.id}) `;
      container.style.display = 'none';
      inputRef.focus();
    });

    container.appendChild(item);
  });

  container.style.display = 'block';
}

function inputPreparativoHandler(event, index) {
  const input = event.target;
  aplicarSubstituicoesSeta(input);

  const valor = input.value;
  const indexParenteses = valor.lastIndexOf('(');
  if (indexParenteses !== -1) {
    mostrarSugestoes(
      valor.slice(indexParenteses + 1).toLowerCase(),
      input,
      `prepSugestoes${index}`
    );
  } else {
    esconderSugestoes(`prepSugestoes${index}`);
  }
}

function esconderSugestoes(id = null) {
  if (id) {
    const container = document.getElementById(id);
    if (container) {
      container.style.display = 'none';
      container.innerHTML = '';
    }
  } else {
    document.querySelectorAll('.sug-autocomplete').forEach(container => {
      container.style.display = 'none';
      container.innerHTML = '';
    });
  }
}

document.getElementById('impacto').addEventListener('focus', function (e) {
  if (e.target.value.trim() === '') {
    e.target.value = '1. ';
  }
});

document.getElementById('impacto').addEventListener('keydown', function (e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const textarea = e.target;
    const linhas = textarea.value.split('\n');
    const linhaAtual = linhas.length + 1;
    
    textarea.value += `\n${linhaAtual}. `;
    
    textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
  }
});

function exportarJson() {
  const data = {
        escopo: document.getElementById('escopo').value,
        impacto: document.getElementById('impacto').value,
        criterios,
        passos,
        preparativos, // <-- Aqui
        navegadores: {
            chrome: document.getElementById('chrome').checked,
            edge: document.getElementById('edge').checked
        },
        bancos: {
            sqlserver: document.getElementById('sqlserver').checked,
            oracleIso: document.getElementById('oracleIso').checked,
            postgres: document.getElementById('postgres').checked,
            oracleUtf: document.getElementById('oracleUtf').checked
        }
  };

  data.templateId = currentTemplateId || gerarIdTemplate();
  data.nomeTarefa = document.getElementById('nomeTarefa').value.trim();

  const nome = document.getElementById('nomeExportar').value.trim() || 
             (nomeTarefa ? nomeTarefa.replace(/\s+/g, '-').toLowerCase() : 'template_gitlab');
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `${nome}.json`;
  link.click();

  // Fecha o modal após exportar
  const modal = bootstrap.Modal.getInstance(document.getElementById('modalExportar'));
  modal.hide();

  Swal.fire({
    icon: 'success',
    title: 'Exportado com sucesso!',
    text: `Arquivo "${nome}.json" baixado.`,
    timer: 2000,
    showConfirmButton: false
  });
}

function gerarIdTemplate() {
  return 'tpl-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now().toString(36);
}

function importarArquivoJson() {
  const fileInput = document.getElementById('arquivoJson');
  const file = fileInput.files[0];

  if (!file) {
    Swal.fire('Nenhum arquivo selecionado', 'Escolha um arquivo JSON para importar.', 'warning');
    return;
  }

  const reader = new FileReader();
  reader.onload = function (event) {
    try {
      const data = JSON.parse(event.target.result);

      currentTemplateId = data.templateId || gerarIdTemplate();

        nomeTarefa = data.nomeTarefa || '';
        document.getElementById('nomeTarefa').value = nomeTarefa;

        // Atualiza título
        document.getElementById('tituloPrincipal').innerHTML = `
        <i class="fas fa-tools"></i> Gerador de Template GitLab 
        ${nomeTarefa ? `<small class="text-muted">(${nomeTarefa})</small>` : ''}
        `;
        document.title = nomeTarefa + '-template' || 'Gerador de Template GitLab';

      // Aplica os dados no formulário
      document.getElementById('escopo').value = data.escopo || '';
      document.getElementById('impacto').value = data.impacto || '';
      criterios = data.criterios || [];
      passos = data.passos || [];
      preparativos = data.preparativos || [];
    
      renderizarPreparativos();
      renderizarCriterios();
      renderizarPassos();

      document.getElementById('chrome').checked = data.navegadores?.chrome || false;
      document.getElementById('edge').checked = data.navegadores?.edge || false;
      document.getElementById('sqlserver').checked = data.bancos?.sqlserver || false;
      document.getElementById('oracleIso').checked = data.bancos?.oracleIso || false;
      document.getElementById('postgres').checked = data.bancos?.postgres || false;
      document.getElementById('oracleUtf').checked = data.bancos?.oracleUtf || false;

      // Fecha modal e avisa
      const modalEl = document.getElementById('modalImportar');
      const modal = bootstrap.Modal.getInstance(modalEl);
      modal.hide();

      Swal.fire({
        icon: 'success',
        title: 'Importado com sucesso!',
        text: 'O template foi carregado e está pronto para uso.',
        timer: 2000,
        showConfirmButton: false
      });
    } catch (err) {
      Swal.fire('Erro!', 'O arquivo não é um JSON válido.', 'error');
    }
  };

  reader.readAsText(file);

    const nomeArquivo =
    data.nomeTarefa?.trim() ||
    file.name.replace('.json', '') ||
    'template_gitlab';

    document.getElementById('nomeExportar').value = nomeArquivo;

    const titulo = document.getElementById('tituloPrincipal').innerHTML =
  `<i class="fas fa-tools"></i> Gerador de Template GitLab <small class="text-muted">(${nomeArquivo})</small>`;
}

function aplicarSubstituicoesSeta(elemento) {
  const cursor = elemento.selectionStart;
  const antes = elemento.value;
  const depois = antes.replace(/ > /g, ' → ').replace(/> /g, '→ ').replace(/ >(?=\S)/g, ' →');

  if (antes !== depois) {
    elemento.value = depois;
    elemento.selectionEnd = cursor;
  }
}

document.getElementById('novoPasso').addEventListener('input', function (e) {
  aplicarSubstituicoesSeta(e.target);

  const valor = e.target.value;
  const indexParenteses = valor.lastIndexOf('(');
  if (indexParenteses !== -1) {
    mostrarSugestoes(valor.slice(indexParenteses + 1).toLowerCase(), e.target, 'sugestoesPasso');
  } else {
    esconderSugestoes();
  }
});

document.getElementById('novoPasso').addEventListener('blur', () => setTimeout(() => esconderSugestoes('sugestoesPasso'), 150));

</script>

<script>

let blocosDePassos = [];

if (typeof window.getBlocosDePassos === 'function') {
    blocosDePassos = window.getBlocosDePassos();
}

document.getElementById('novoPasso').addEventListener('input', function (e) {
  const valor = e.target.value;
  if (valor.trim() === '/') {
    mostrarModalBlocos(); // Abre o modal
  }
});

function mostrarModalBlocos(prepIndex = null) {
  const modalBody = document.getElementById('modalBlocosBody');
  modalBody.innerHTML = '';

  blocosDePassos.forEach((bloco, index) => {
    const btn = document.createElement('button');
    btn.className = 'list-group-item list-group-item-action';
    btn.textContent = bloco.titulo;
    btn.onclick = () => aplicarBlocoDePassos(index, prepIndex);
    modalBody.appendChild(btn);
  });

  const modalEl = document.getElementById('modalBlocos');
  let modal = bootstrap.Modal.getInstance(modalEl);

  if (!modal) {
    modal = new bootstrap.Modal(modalEl);
  }

  modal.show();
}

function aplicarBlocoDePassos(blocoIndex, prepIndex = null) {
  const bloco = blocosDePassos[blocoIndex];

  if (prepIndex === null) {
    // Insere nos passos principais
    bloco.passos.forEach(p => {
      passos.push({
        texto: p.texto,
        critico: false,
        criteriosVinculados: []
      });
    });
    renderizarPassos();
  } else {
    // Insere nos preparativos[prepIndex].passos
    bloco.passos.forEach(p => {
      preparativos[prepIndex].passos.push(p.texto);
    });
    renderizarPreparativos();
  }

  document.getElementById('novoPasso').value = '';
  const modal = bootstrap.Modal.getInstance(document.getElementById('modalBlocos'));
  modal.hide();
}

let sugestoesAutoComplete = [];
if (typeof window.getSugestoesAutoComplete === 'function') {
  sugestoesAutoComplete = window.getSugestoesAutoComplete();
}

function getPrefixosValidos() {
  return [...new Set(sugestoesAutoComplete.map(s => s.id.match(/^[A-Z]+/)[0]))];
}

function atualizarSugestoesPorParenteses(inputEl, containerId) {
  const texto = inputEl.value;
  const indexParenteses = texto.lastIndexOf('(');

  if (indexParenteses === -1) {
    esconderSugestoes(containerId);
    return;
  }

  const filtroParcial = texto.slice(indexParenteses + 1).toLowerCase();

  const sugestoesFiltradas = sugestoesAutoComplete.filter(s =>
    s.id.toLowerCase().startsWith(filtroParcial)
  );

    const container = document.getElementById(containerId);
    container.innerHTML = '';
    sugestoesFiltradas.forEach(s => {
    const item = document.createElement('li');
    item.className = 'list-group-item list-group-item-action';
    item.textContent = `${s.name} (${s.id})`;
    item.dataset.id = s.id;
    item.dataset.name = s.name;

    item.onclick = () => {
        const textoAtual = inputEl.value;
        const prefixo = textoAtual.slice(0, indexParenteses);
        inputEl.value = prefixo + `${s.name} (${s.id}) `;
        container.style.display = 'none';
        inputEl.focus();
    };

    container.appendChild(item);
    });
    container.style.display = 'block';
}

document.getElementById('novoPasso').addEventListener('input', function (e) {
  aplicarSubstituicoesSeta(e.target);
  atualizarSugestoesPorParenteses(e.target, 'sugestoesPasso');

  if (e.target.value.trim() === '/') {
    mostrarModalBlocos();
  }
});

document.getElementById('novoPasso').addEventListener('blur', () =>
  setTimeout(() => esconderSugestoes('sugestoesPasso'), 150)
);

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
